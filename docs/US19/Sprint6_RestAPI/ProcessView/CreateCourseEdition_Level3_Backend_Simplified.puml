@startuml
title: US19: As an ASC, I want to create a course edition\n(Process View - Level 3: Core Flow Only - Backend)


autonumber

skinparam {
  ActivityPadding 2
  ActivityMargin 2
  BoxPadding 2
}
skinparam sequence {
    LifeLineBorderColor Grey
    LifeLineBackgroundColor HoneyDew
}
skinparam defaultTextAlignment center
skinparam shadowing true


participant "<<component>>\n:Router" as router #E1F5FE
participant "<<component>>\n:CourseEditionRestController\n(REST Controller)" as Controller #E1F5FE
participant "<<component>>\n:ICourseEditionAssembler\n(Assembler)" as Assembler #E1F5FE
participant "<<component>>\n:ICreateCourseEditionService\n(Service)" as Service #E1F5FE
participant "<<component>>\n:ICourseEditionFactory\n(Factory)" as CourseEditionFactory #E1F5FE
participant "<<component>>\n:ICourseEditionRepository\n(Repository)" as Repository #E1F5FE
participant "<<component>>\n:ICourseEditionMapper\n(Mapper)" as Mapper #E1F5FE
participant "<<component>>\n:ICourseEditionIDMapper\n(Mapper)" as IDMapper #E1F5FE
participant "<<component>>\n:IProgrammeEditionIDMapper\n(Mapper)" as PEMapper #E1F5FE
participant "<<component>>\n:ICourseInStudyPlanIDMapper\n(Mapper)" as CSPMapper #E1F5FE
participant "<<component>>\n:ICourseEdition\nSpringDataRepository\n(JPARepository)" as SpringData #E1F5FE

database DB as Database #E1F5FE

note over router
This simplified version of the diagram focuses only
on the core backend flow for creating a course edition.
Supporting GET endpoints (e.g., programmes,
courses) are omitted for clarity.
end note

== Step 1: HTTP Request ==

' --- GET endpoints omitted for brevity ---

-> router: POST /course-editions
activate router
router -> Controller: createCourseEdition(JSON)

activate Controller

note over Controller #EEEEEE
Spring Boot automatically converts
incoming JSON to
CourseEditionRequestDTO
end note

== Step 2: Assemble to Command ==

Controller -> Assembler: toCommand(requestDTO)
activate Assembler
Assembler --> Controller: createCourseEditionCommand
deactivate Assembler



Controller -> Service: createAndSaveCourseEdition(dto)
activate Service

== Step 3: Application Service & Factory ==

Service -> CourseEditionFactory: createCourseEditionToDomain\n(courseInStudyPlanID, programmeEditionID)\n(cSp1_ID, pE1_ID)
activate CourseEditionFactory
CourseEditionFactory --> Service -- : CourseEdition
Service -> Repository: containsOfIdentity(courseEdition.identity())
activate Repository
Repository --> Service: false
deactivate Repository


== Step 4: Persistence ==

Service -> Mapper : toDataModel(courseEdition)
activate Mapper
Mapper -> IDMapper : toDataModel(courseEditionID)
activate IDMapper
IDMapper -> PEMapper : toDataModel(programmeEditionID)
activate PEMapper
PEMapper --> IDMapper : ProgrammeEditionIdDataModel
deactivate PEMapper
IDMapper -> CSPMapper : toDataModel(courseInStudyPlanID)
activate CSPMapper
CSPMapper --> IDMapper : CourseInStudyPlanIDDataModel
deactivate CSPMapper
IDMapper --> Mapper : CourseEditionIDDataModel
deactivate
Mapper --> Service : CourseEditionDataModel
deactivate



Service -> SpringData : save(courseEditionDataModel)
activate SpringData

group Database
SpringData -> Database: INSERT INTO course_edition (...)
activate Database
Database --> SpringData: success
deactivate Database
end


SpringData --> Service : CourseEditionDataModel
deactivate

== Step 5: Return DTO ==

Service -> Mapper : toDomain(courseEditionDataModel)
activate Mapper
Mapper --> Service : CourseEdition
deactivate

Service -> Assembler: toDTO(courseEdition)
activate Assembler
Assembler --> Service: responseDTO
deactivate Assembler

Service --> Controller : responseDTO
deactivate

Controller --> router:  (200 OK) Course Edition\n created successfully!
deactivate Controller

<-- router:  (200 OK) Course Edition\n created successfully!
@enduml

