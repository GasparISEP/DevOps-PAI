@startuml
title US17 - enroll a student in a programme in a given school year and in a set of courses
actor ASC
participant ":UI" as UI
ASC -> UI : I want to enroll a student in a programme in a given school year and in a set of courses.
activate UI
UI --> ASC : What student?
deactivate UI
ASC -> UI : Enter the student!

'' Get Programmes

activate UI
participant ":US17_EnrollStudentInProgrammeEditionAndSetOfCoursesEditionsController" as Controller
UI -> Controller : getAllProgrammes()
activate Controller
participant ":ProgrammeRepository" as ProgrammeRepository
Controller -> ProgrammeRepository : getAllProgrammes()
activate ProgrammeRepository
participant ":ProgrammeRepositoryListFactoryImpl" as ProgrammeRepositoryListFactoryImpl
ProgrammeRepository -> ProgrammeRepositoryListFactoryImpl : copyProgrammeArrayList(List<Programme>)
activate ProgrammeRepositoryListFactoryImpl
create "copyPgmList[i]:ProgrammeRepositoryListFactory"
ProgrammeRepositoryListFactoryImpl -> "copyPgmList[i]:ProgrammeRepositoryListFactory": copyProgrammeArrayList(List<Programme>)
activate "copyPgmList[i]:ProgrammeRepositoryListFactory"
"copyPgmList[i]:ProgrammeRepositoryListFactory" --> ProgrammeRepositoryListFactoryImpl: EmptyList<Programme>
deactivate "copyPgmList[i]:ProgrammeRepositoryListFactory"
ProgrammeRepositoryListFactoryImpl --> ProgrammeRepository : copyOfProgrammeList
deactivate ProgrammeRepositoryListFactoryImpl
ProgrammeRepository --> Controller : copyOfProgrammeList
deactivate ProgrammeRepository
Controller --> UI : listOfProgrammes
deactivate Controller
UI --> ASC : Here is the list of Programmes! What programme do you want?
deactivate UI
ASC -> UI : Enter the programme!

'' Get SchoolYears

activate UI
participant ":SchoolYearRepository" as SchoolYearRepository
UI -> Controller : getAllSchoolYears()
activate Controller
participant ":SchoolYearRepository" as SchoolYearRepository
Controller -> SchoolYearRepository : getAllSchoolYears()
activate SchoolYearRepository
participant ":SchoolYearRepositoryListFactoryImpl" as SchoolYearRepositoryListFactoryImpl
SchoolYearRepository -> SchoolYearRepositoryListFactoryImpl : copySchoolYearArrayList(List<SchoolYear>)
activate SchoolYearRepositoryListFactoryImpl
create "copySchoolYearList[i]:SchoolYearRepositoryListFactory"
SchoolYearRepositoryListFactoryImpl -> "copySchoolYearList[i]:SchoolYearRepositoryListFactory": copySchoolYearArrayList(List<SchoolYear>)
activate "copySchoolYearList[i]:SchoolYearRepositoryListFactory"
"copySchoolYearList[i]:SchoolYearRepositoryListFactory" --> SchoolYearRepositoryListFactoryImpl: EmptyList<SchoolYear>
deactivate "copySchoolYearList[i]:SchoolYearRepositoryListFactory"
SchoolYearRepositoryListFactoryImpl --> SchoolYearRepository : copyOfSchoolYearList
deactivate SchoolYearRepositoryListFactoryImpl
SchoolYearRepository --> Controller : copyOfSchoolYearsList
deactivate SchoolYearRepository
Controller --> UI : listOfSchoolYears
deactivate Controller
UI --> ASC : Here is the list SchoolYears! What schoolYear do you want?
deactivate UI
ASC -> UI : Enter the schoolYear!
activate UI
UI --> ASC : Sure?
deactivate UI
ASC -> UI : Yes!

activate UI
UI -> Controller : enrollStudentInProgrammeEditionAndSetOfCoursesEditions(student, programme, schoolYear)
activate Controller
participant ":ProgrammeEnrolmentRepository" as ProgrammeEnrolmentRepository

'' Is Student Enrolled

Controller -> ProgrammeEnrolmentRepository : isStudentEnrolled(student, programme)
activate ProgrammeEnrolmentRepository
participant "e[i]:ProgrammeEnrollment" as Enrollment
loop for each "e[i]:ProgrammeEnrollment" as Enrolment
ProgrammeEnrolmentRepository -> Enrollment : Student: getStudentFromEnrolment()
ProgrammeEnrolmentRepository -> Enrollment : Programme: getProgrammeFromEnrolment()
end
deactivate Enrollment
ProgrammeEnrolmentRepository --> Controller : True

'' Find Programme Edition by SchoolYear and Programme

deactivate ProgrammeEnrolmentRepository
participant ":ProgrammeEditionRepository" as ProgrammeEditionRepository
Controller -> ProgrammeEditionRepository : findProgrammeEditionBySchoolYearAndProgramme(programme, schoolYear)
activate ProgrammeEditionRepository
participant ":ProgrammeEdition" as ProgrammeEdition
loop for each "pe[i]:ProgrammeEditionRepository" as ProgrammeEditionRepository
ProgrammeEditionRepository -> ProgrammeEdition : programmeEdition : findProgrammeInProgrammeEdition(programme)
ProgrammeEditionRepository -> ProgrammeEdition : programmeEdition : findSchoolYearInProgrammeEdition(schoolYear)
ProgrammeEdition --> ProgrammeEditionRepository : pe1
end
ProgrammeEditionRepository --> Controller :  pe1
deactivate ProgrammeEditionRepository

'' Is Student Enrolled in This Programme Edition

participant ":ProgrammeEditionEnrollmentRepository" as ProgrammeEditionEnrollmentRepository
Controller -> ProgrammeEditionEnrollmentRepository : isStudentEnrolledInThisProgrammeEdition(student, pe1)
activate ProgrammeEditionEnrollmentRepository
participant ":ProgrammeEditionEnrollment" as ProgrammeEditionEnrollment
loop for each "pee[i]:ProgrammeEditionEnrollmentRepository" as ProgrammeEditionEnrollmentRepository
participant ":Student" as Student
ProgrammeEditionEnrollmentRepository -> ProgrammeEditionEnrollment: ProgrammeEditionEnrollment: findProgrammeEditionInEnrollment()
ProgrammeEditionEnrollmentRepository -> Student: ProgrammeEditionEnrollment: getUniqueNumber()
participant ":ProgrammeEditionEnrollment" as ProgrammeEditionEnrollment
end
ProgrammeEditionEnrollmentRepository --> Controller : False
deactivate "ProgrammeEditionEnrollmentRepository"

'' Enroll Student in Programme Edition

Controller -> ProgrammeEditionEnrollmentRepository : enrollStudentInProgrammeEdition(student, pe1)
activate "ProgrammeEditionEnrollmentRepository"
participant ":IProgrammeEditionEnrollmentFactory" as IProgrammeEditionEnrollmentFactory
ProgrammeEditionEnrollmentRepository -> IProgrammeEditionEnrollmentFactory: newProgrammeEditionEnrollment(student, pe1)
activate IProgrammeEditionEnrollmentFactory
create "pee1:ProgrammeEditionEnrollment"
IProgrammeEditionEnrollmentFactory -> "pee1:ProgrammeEditionEnrollment" : newProgrammeEditionEnrollment(student, pe1)
activate "pee1:ProgrammeEditionEnrollment"
"pee1:ProgrammeEditionEnrollment" --> IProgrammeEditionEnrollmentFactory: pee1
deactivate "pee1:ProgrammeEditionEnrollment"
IProgrammeEditionEnrollmentFactory --> ProgrammeEditionEnrollmentRepository: pee1
deactivate IProgrammeEditionEnrollmentFactory
create "pe[i]:ProgrammeEditionArrayList"
ProgrammeEditionEnrollmentRepository -> "pe[i]:ProgrammeEditionArrayList":  add(pee1)
activate "pe[i]:ProgrammeEditionArrayList"
ProgrammeEditionEnrollmentRepository <-- "pe[i]:ProgrammeEditionArrayList":  True
deactivate "pe[i]:ProgrammeEditionArrayList"
ProgrammeEditionEnrollmentRepository --> Controller : True
deactivate ProgrammeEditionEnrollmentRepository

'' Find Course Edition by Programme Edition

participant ":CourseEditionRepository" as CourseEditionRepository
Controller -> CourseEditionRepository : findCourseEditionsByProgrammeEdition(pee1)
participant ":CourseEdition" as CourseEdition
activate CourseEditionRepository
participant ":CourseEditionListFactory" as CourseEditionListFactory
CourseEditionRepository -> CourseEditionListFactory: newArrayList()
activate CourseEditionListFactory
create "ce[i]:CourseEditionArrayList"
CourseEditionListFactory -> "ce[i]:CourseEditionArrayList": newArrayList ()
activate "ce[i]:CourseEditionArrayList"
"ce[i]:CourseEditionArrayList" --> CourseEditionListFactory: EmptyList<CourseEdition>
deactivate "ce[i]:CourseEditionArrayList"
CourseEditionListFactory --> CourseEditionRepository: EmptyList<CourseEdition>
deactivate CourseEditionListFactory
loop for each "ce[i]:CourseEditionRepository" as CourseEditionRepository
CourseEditionRepository -> CourseEdition :  whatProgrammeEditionBelongsThisCourseEdition()
activate CourseEdition
CourseEdition --> CourseEditionRepository : ce1
deactivate CourseEdition
participant ":CourseEditionArrayList" as CourseEditionArrayList
CourseEditionRepository -> "ce[i]:CourseEditionArrayList" :  add(ce1)
activate "ce[i]:CourseEditionArrayList"
"ce[i]:CourseEditionArrayList" --> CourseEditionRepository: True
deactivate "ce[i]:CourseEditionArrayList"
end
participant ":CourseEditionEnrollmentRepository" as CourseEditionEnrollmentRepository
CourseEditionRepository -> CourseEditionEnrollmentRepository : ListOfCourseEditions
deactivate CourseEditionRepository
participant ":CourseEditionEnrollment" as CourseEditionEnrollment
activate CourseEditionEnrollmentRepository
loop for each "cee[i]:CourseEditionEnrollmentRepository" as CourseEditionEnrollmentRepository
CourseEditionEnrollmentRepository -> CourseEditionEnrollment : findByStudentAndEdition(student, cee[i])
CourseEditionEnrollmentRepository -> CourseEditionEnrollment : isPresent()
create CourseEditionEnrollmentHashSet
CourseEditionEnrollmentRepository -> CourseEditionEnrollmentHashSet : enrollStudentInACourseEdition(student, cee1)
activate CourseEditionEnrollmentHashSet
CourseEditionEnrollmentHashSet --> CourseEditionEnrollmentRepository : True
deactivate CourseEditionEnrollmentHashSet
end
CourseEditionEnrollmentRepository --> Controller : True
deactivate CourseEditionEnrollmentRepository
Controller --> UI : True
deactivate Controller
UI --> ASC: OK!
deactivate UI

@enduml