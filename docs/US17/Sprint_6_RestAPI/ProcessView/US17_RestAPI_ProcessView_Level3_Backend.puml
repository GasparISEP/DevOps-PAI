@startuml

' US17 - Backend Granular Flow
' Process View - Level 3 Backend

autonumber

title US17: Enrol a Student in a ProgrammeEdition \n (Process View - Level 3 - Backend Only)

participant ":StudentProgrammeEditionEnrolmentRestController" as controller <<component>> <<RESTController>>
participant ":ProgrammeEditionEnrolmentRequest" as requestDTO <<component>> <<DTO>>
participant ":ProgrammeEditionEnrolmentServiceImpl" as service <<component>> <<Service>>
participant ":ProgrammeEditionEnrolmentFactoryImpl" as factory <<component>> <<Domain>>
participant ":IProgrammeEnrolmentRepository" as programmeEnrRepo <<component>> <<Repository>>
participant ":IProgrammeEditionRepository" as editionRepo <<component>> <<Repository>>
participant ":IProgrammeEditionEnrolmentRepository" as enrolmentRepo <<component>> <<Repository>>

-> controller: POST /programmeeditions/{programmeAcronym}/{programmeName}/{schoolYearId}/enrolments
activate controller

controller -> requestDTO: parse JSON -> requestDTO
requestDTO --> controller: studentId

controller -> service: enrolStudentInProgrammeEditionAndSetOfCoursesEditions(studentId, programmeId, schoolYearId)
activate service

service -> programmeEnrRepo: isStudentEnrolled(studentId, programmeId)
programmeEnrRepo --> service: true

service -> editionRepo: findProgrammeEditionIDByProgrammeIDAndSchoolYearID(programmeId, schoolYearId)
editionRepo --> service: programmeEditionId

service -> enrolmentRepo: isStudentEnrolledInThisProgrammeEdition(studentId, programmeEditionId)
enrolmentRepo --> service: false

service -> factory: newProgrammeEditionEnrolment(studentId, programmeEditionId)
factory --> service: ProgrammeEditionEnrolment

service -> enrolmentRepo: save(ProgrammeEditionEnrolment)
enrolmentRepo --> service: OK

service --> controller: success
controller --> : return 201 CREATED

@enduml
