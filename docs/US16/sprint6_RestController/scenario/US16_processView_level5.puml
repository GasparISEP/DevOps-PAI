@startuml
title US16: Enroll a Student in a Course Edition - Process View Level 5
autonumber

' Set colors for different types of lines
skinparam sequence {
    ArrowColor #2C3E50
    LifeLineBorderColor #2C3E50
    LifeLineBackgroundColor #ECF0F1
    ParticipantBorderColor #2C3E50
    ParticipantBackgroundColor #ECF0F1
    ParticipantFontColor #2C3E50
    ActorBorderColor #2C3E50
    ActorBackgroundColor #ECF0F1
    ActorFontColor #2C3E50
    DatabaseBorderColor #2C3E50
    DatabaseBackgroundColor #ECF0F1
    DatabaseFontColor #2C3E50
}

participant ":Router" as router
participant ":CourseEditionEnrolmentRestController" as Controller
participant ":CourseEditionEnrolmentService" as Service
participant ":CourseEditionEnrolmentRepository" as Repository
participant ":CourseEditionEnrolmentAssembler" as Assembler
participant ":CourseEditionEnrolmentFactory" as Factory
participant "CourseEditionEnrolment" as Enrolment

database "Database" as DB

router -> Controller: POST /courseeditions/students/enrolments
activate Controller

Controller -> Assembler: toCourseEditionID(CourseEditionEnrolmentDto)
activate Assembler
Assembler --> Controller: CourseEditionID
deactivate Assembler
Controller -> Assembler: toStudentID(CourseEditionEnrolmentDto)
activate Assembler
Assembler --> Controller: StudentID
deactivate Assembler

Controller -> Service: enrolStudentInACourseEdition(CourseEditionID, StudentID)
activate Service
Service -> Factory: createCourseEditionEnrolment(CourseEditionID, StudentID)
activate Factory
create Enrolment
Factory -> Enrolment: create
Factory --> Service: CourseEditionEnrolment
deactivate Factory

Service -> Service: validateEnrollment(courseEditionEnrolment)
Service -> Repository: isStudentEnrolledInCourseEdition(studentId, courseEditionId)
activate Repository
Repository -> DB: SELECT * FROM CourseEditionEnrolment WHERE CourseEditionEnrolment.CourseEditionID = ? AND CourseEditionEnrolment.StudentID = ?
activate DB
DB --> Repository: ResultSet
deactivate DB
Repository --> Service: false
deactivate Repository
Service --> Service: true

Service -> Assembler: toDataModel(CourseEditionEnrolment)
activate Assembler
note right of Assembler
  Transformations:
  1. StudentID VO -> StudentIDDataModel
  2. CourseEditionID VO -> CourseEditionIDDataModel
  3. All nested VOs -> corresponding DataModels
end note
Assembler --> Service: CourseEditionEnrolmentDataModel
deactivate Assembler

Service -> Repository: save(courseEditionEnrolmentDataModel)
activate Repository
Repository -> DB: INSERT INTO course_edition_enrolments
activate DB
DB --> Repository: Success
deactivate DB
Repository --> Service: true
deactivate Repository

Service --> Controller: true
deactivate Service

Controller --> router: 201 Created
deactivate Controller

@enduml 